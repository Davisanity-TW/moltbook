#!/usr/bin/env python3
"""Moltbook digest renderer (no LLM).

This script is now a *lightweight* formatter only.
High-quality zh-Hant summaries are produced by the cron agent (LLM) using
`bin/moltbook_fetch_candidates.py` output.

Output path: reports/YYYYMM/MM-DD.md (append blocks).
"""

from __future__ import annotations

import json
import datetime as dt
from pathlib import Path

try:
    from zoneinfo import ZoneInfo
except Exception:
    ZoneInfo = None


def tz_now():
    if ZoneInfo is None:
        return dt.datetime.now()
    return dt.datetime.now(tz=ZoneInfo("Asia/Taipei"))


def main():
    now = tz_now()
    day = now.date().isoformat()
    ym = now.strftime("%Y%m")
    out_dir = Path("/home/ubuntu/clawd/moltbook/reports") / ym
    out_dir.mkdir(parents=True, exist_ok=True)
    out_file = out_dir / f"{now.strftime('%m-%d')}.md"

    if not out_file.exists():
        out_file.write_text(
            f"# Moltbook 精選點子（{day}）\n\n"
            f"來源：熱門前200 + 最新400（合併去重後挑選）\n\n",
            encoding="utf-8",
        )

    # Read candidates (generated by fetch script)
    cpath = Path("/tmp/moltbook_candidates.json")
    if not cpath.exists():
        raise SystemExit("/tmp/moltbook_candidates.json not found. Run bin/moltbook_fetch_candidates.py first")

    data = json.loads(cpath.read_text(encoding="utf-8"))
    posts = data.get("posts") or []

    block = []
    block.append(f"## {day} {now.strftime('%H:%M')} (Asia/Taipei)\n")
    block.append(f"本輪候選：unique={data.get('counts',{}).get('unique')} selected={data.get('counts',{}).get('selected')}\n")
    block.append("（提示：本檔案的『中文摘要』將由 cron 的 LLM 版流程產出；這個 script 只負責落檔框架。）\n")

    for p in posts[:12]:
        pid = p.get("id")
        title = (p.get("title") or "(no title)").strip()
        ext = p.get("url")
        post_url = f"https://www.moltbook.com/post/{pid}" if pid else "(no id)"

        # Preferred output format (David):
        # - Title
        # - 連結：...
        # - 中文摘要：
        #   1. ...
        #   2. ...
        # - 可複製給 molt 的任務：
        #   ```
        #   ...
        #   ```
        block.append(f"- {title}")
        block.append(f"  - 連結：{post_url}")
        if ext:
            block.append(f"  - 外部連結：{ext}")
        block.append("  - 中文摘要：")
        block.append("    1. （待產生）")
        block.append("    2. （待產生）")
        block.append("    3. （待產生）")
        block.append("    4. （待產生）")
        block.append("    5. （待產生）")
        block.append("    6. （待產生）")
        block.append("  - 可複製給 molt 的任務：")
        block.append("    ```")
        block.append("    請用繁體中文輸出：")
        block.append("    1) 6–10 點中文重點摘要（翻譯＋整理，可執行、可落地）")
        block.append("    2) 把重點轉成我可以直接套用到現有 Clawdbot 任務的改進建議（cache/規則/小模型/流程拆分/排程）")
        block.append("    3) 給一個『兩段式 pipeline』（cache 產生 + 準點發送/寫入 git）的具體設計草案")
        block.append("    4) 最後附上 Moltbook 連結（原文）")
        block.append("    ```")
        block.append("")

    out_file.write_text(out_file.read_text(encoding="utf-8") + "\n" + "\n".join(block), encoding="utf-8")
    print(str(out_file))


if __name__ == "__main__":
    main()
